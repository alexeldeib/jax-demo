---
apiVersion: jobset.x-k8s.io/v1alpha2
kind: JobSet
metadata:
  name: ace-jax-demo
spec:
  network:
    enableDNSHostnames: true
  failurePolicy:
    maxRestarts: 10
  startupPolicy:
    startupPolicyOrder: InOrder
  replicatedJobs:
  - name: jax
    template:
      spec:
        parallelism: 2
        completions: 2
        backoffLimit: 0
        template:
          spec:
            restartPolicy: Never
            tolerations:
            - key: "cohere.com/reserved"
              operator: "Equal"
              value: "ace"
              effect: "NoSchedule"
            terminationGracePeriodSeconds: 1
            volumes:
            - name: jax-code
              configMap:
                name: ace-jax-demo
            - name: storage
              persistentVolumeClaim:
                claimName: ace-jax-demo
            - name: memfs
              emptyDir:
                medium: Memory
                sizeLimit: 10Gi
            containers:
            - name: jax
              image: nvcr.io/nvidia/jax:24.10-py3
              imagePullPolicy: IfNotPresent
              volumeMounts:
              - name: jax-code
                mountPath: /app/do.py
                subPath: do.py
              - name: storage
                mountPath: /storage
              - name: memfs
                mountPath: /dev/shm
              env:
              - name: COORDINATOR_ADDRESS
                value: "ace-jax-demo-jax-0-0.ace-jax-demo.default.svc.cluster.local:8471"
              - name: NCCL_IB_DISABLE
                value: "1"
              - name: JOB_SIZE
                value: "2"
              ports: 
              - containerPort: 8471
              resources:
                requests:
                  nvidia.com/gpu: 8
                limits:
                  nvidia.com/gpu: 8
              command: 
                - bash
                - -c
                - |
                  python /app/do.py | tee -a /storage/log.txt
                  if [ ${PIPESTATUS[0]} != 0 ]; then
                    echo "Job failed"
                    exit 1
                  fi
                  sleep infinity
